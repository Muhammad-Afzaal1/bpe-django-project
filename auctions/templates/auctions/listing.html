{% extends "auctions/layout.html" %}

{% block body %}

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {% if user.is_authenticated %}
        <form action="{% url 'toggle_watchlist' listing.id %}" method="post">
            {% csrf_token %}
            {% if in_watchlist %}
                <button class="btn btn-warning mb-3">Remove from Watchlist</button>
            {% else %}
                <button class="btn btn-success mb-3">Add to Watchlist</button>
            {% endif %}
        </form>
    {% endif %}

    <h1>{{ listing.title }}</h1>

    <img class="img-fluid mb-3" style="max-width: 400px;" src="{{ listing.image }}" alt="Item Image">

    <p class="description">{{ listing.description }}</p>

    <h2 class="mt-2">
        ${{ listing.current_price }}
    </h2>

    {% if listing.listing_type == "auction" %}
        <div class="text-muted">{{ listing.bids.count }} bids so far</div>
    {% else %}
        <div class="badge bg-success">Buy Now</div>
    {% endif %}

    <hr>

    {% if user.is_authenticated %}

        {% if listing.creator == user %}
            <!-- SELLER VIEW -->

            {% if listing.active %}
                <form action="{% url 'close_listing' listing.id %}" method="post">
                    {% csrf_token %}
                    <button class="btn btn-danger">Close Listing</button>
                </form>
            {% else %}
                {% if listing.listing_type == "auction" and listing.highest_bid %}
                    <div class="alert alert-success mt-3">
                        Winner: {{ listing.highest_bid.bidder.username }} with ${{ listing.highest_bid.amount }}
                    </div>
                {% else %}
                    <div class="alert alert-info mt-3">
                        Listing is closed.
                    </div>
                {% endif %}
            {% endif %}

        {% else %}
            <!-- BUYER VIEW -->

            {% if listing.active %}

                {% if listing.listing_type == "auction" %}
                    <!-- AUCTION BID FORM -->
                    <form method="post" class="mt-3">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="mb-2">
                                {{ field }}
                                {% if field.errors %}
                                    <div class="text-danger small">
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                        <button class="btn btn-primary">Place Bid</button>
                    </form>

                {% else %}
                    <!-- BUY NOW -->
                    <form action="{% url 'buy_now' listing.id %}" method="post" class="mt-3">
                        {% csrf_token %}
                        <button class="btn btn-success btn-lg">
                            Buy Now for ${{ listing.buy_now_price }}
                        </button>
                    </form>
                {% endif %}

            {% else %}
                {% if listing.listing_type == "auction" and listing.highest_bid.bidder == user %}
                    <div class="alert alert-success mt-3">
                        ðŸŽ‰ You won this auction!
                    </div>
                {% else %}
                    <div class="alert alert-secondary mt-3">
                        Listing is closed.
                    </div>
                {% endif %}
            {% endif %}

        {% endif %}

    {% else %}
        {% if listing.active %}
            <a href="{% url 'login' %}">Login to continue</a>
        {% endif %}
    {% endif %}

    <hr>

    <h3>Details</h3>
    <ul>
        <li>Listed by: {{ listing.creator.username }}</li>
        <li>
            Category:
            {% if listing.category %}
                {{ listing.category }}
            {% else %}
                No Category
            {% endif %}
        </li>
        <li>Type: {{ listing.get_listing_type_display }}</li>
    </ul>

    <hr>

    <h3>Comments</h3>

    {% if user.is_authenticated %}
        <form action="{% url 'add_comment' listing.id %}" method="post">
            {% csrf_token %}
            {% for field in comment_form %}
                <div class="mb-2">{{ field }}</div>
            {% endfor %}
            <button class="btn btn-primary">Add Comment</button>
        </form>
    {% else %}
        <p><a href="{% url 'login' %}">Login</a> to comment</p>
    {% endif %}

    {% if comments %}
        <div class="mt-3">
            {% for comment in comments %}
                <div class="border rounded p-2 mb-2">
                    <strong>{{ comment.user.username }}</strong>
                    <p class="mb-0">{{ comment.comment }}</p>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No comments yet.</p>
    {% endif %}

{% endblock %}
