{% extends "auctions/layout.html" %}

{% block body %}

<div class="container-fluid mt-3">
    <h2 class="mb-4 fw-bold">Seller Dashboard</h2>

    {% if listings %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for listing in listings %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 transition-card {% if not listing.active %}opacity-75{% endif %}">
                <!-- Image Wrapper -->
                <div class="card-img-top-wrapper position-relative"
                    style="height: 200px; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                    {% if listing.image %}
                    <img src="{{listing.image}}" class="card-img-top" alt="{{listing.title}}"
                        style="max-height: 100%; width: auto; max-width: 100%;">
                    {% else %}
                    <span class="text-muted">No Image</span>
                    {% endif %}

                    <!-- Listing Type Badge (Left) -->
                    <span
                        class="position-absolute top-0 start-0 m-2 badge bg-{% if listing.listing_type == 'auction' %}warning text-dark{% else %}info{% endif %}">
                        {% if listing.listing_type == 'auction' %}Auction{% else %}Buy Now{% endif %}
                    </span>

                    <!-- Status Badge (Right) -->
                    <span
                        class="position-absolute top-0 end-0 m-2 badge bg-{% if listing.active %}success{% else %}secondary{% endif %}">
                        {% if listing.active %}Active{% else %}Inactive{% endif %}
                    </span>
                </div>

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold text-truncate" title="{{listing.title}}">
                        <a href="{% url 'listing' listing.id %}"
                            class="text-decoration-none text-dark">{{listing.title}}</a>
                    </h5>
                    <p class="card-text text-muted small mb-2">Created: {{listing.date_time|date:"M d, Y"}}</p>

                    <div class="mb-2">
                        {% if listing.average_rating %}
                        <span class="text-warning small">
                            â˜… {{ listing.average_rating }}
                        </span>
                        <span class="text-muted small">
                            ({{ listing.reviews.count }})
                        </span>
                        {% else %}
                        <span class="text-muted small">No ratings</span>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        {% if listing.listing_type == 'buy_now' %}
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">Type:</span>
                            <span class="fw-bold text-info">Buy Now</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">Price:</span>
                            <span class="fw-bold">${{listing.buy_now_price}}</span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span class="small text-muted">Stock:</span>
                            <span
                                class="fw-bold {% if listing.stock == 0 %}text-danger{% else %}text-success{% endif %}">
                                {{listing.stock}}
                            </span>
                        </div>
                        {% else %}
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">Type:</span>
                            <span class="fw-bold text-warning text-dark">Auction</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">Starting Bid:</span>
                            <span>${{listing.starting_bid}}</span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span class="small text-muted">Current Bid:</span>
                            <span class="fw-bold text-primary">
                                {% if listing.highest_bid %}
                                ${{listing.highest_bid.amount}}
                                {% else %}
                                No Bids
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Management Actions -->
                    <div class="mt-auto pt-3 border-top">
                        <form action="{% url 'update_listing' listing.id %}" method="post" class="row g-2">
                            {% csrf_token %}

                            <!-- Toggle Active/Inactive -->
                            <div class="col-8">
                                <button type="submit" name="action" value="toggle_status"
                                    class="btn btn-sm w-100 btn-outline-{% if listing.active %}danger{% else %}success{% endif %}">
                                    {% if listing.active %}Deactivate{% else %}Activate{% endif %}
                                </button>
                            </div>

                            <!-- Close Auction (Separate) -->
                            {% if listing.listing_type == 'auction' and listing.active %}
                            <div class="col-4">
                                <a href="{% url 'close_listing' listing.id %}" class="btn btn-sm btn-danger w-100"
                                    title="Close Auction & Declare Winner">Close</a>
                            </div>
                            {% endif %}

                            <!-- Stock Update (Buy Now Only) -->
                            {% if listing.listing_type == 'buy_now' %}
                            <div class="col-12 mt-2">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Stock</span>
                                    <input type="number" name="stock" class="form-control" value="{{listing.stock}}"
                                        min="0">
                                    <button type="submit" name="action" value="update_stock"
                                        class="btn btn-outline-secondary">Update</button>
                                </div>
                            </div>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <h4 class="text-muted">You haven't created any listings yet.</h4>
        <a href="{% url 'create_listing' %}" class="btn btn-primary mt-3">Create First Listing</a>
    </div>
    {% endif %}
</div>

{% endblock %}